name: ci

on:
  pull_request:
    branches:
      - master
      - staging
    types:
      - opened
      - reopened
      - synchronize
      - ready_for_review
  push:
    branches:
      - master
      - staging
    paths-ignore:
      - "README.md"

jobs:
  test:
    runs-on: ubuntu-latest
    if: ${{ !github.event.pull_request.draft }}

    services:
      postgres:
        image: postgres:9.6-alpine
        ports:
          - 5432:5432
        env:
          POSTGRES_HOST_AUTH_METHOD: trust
        options: >-
          --health-cmd pg_isready
          --health-interval 10s
          --health-timeout 5s
          --health-retries 5

      mysql:
        image: mysql:5.7
        ports:
          - 3306:3306
        env:
          MYSQL_ALLOW_EMPTY_PASSWORD: true
          MYSQL_DATABASE: 1kb_test

      rabbitmq:
        image: rabbitmq:3.8-alpine
        ports:
          - 5672:5672

      redis:
        image: redis:6.2-alpine
        ports:
          - 6379:6379

      elasticsearch:
        image: 1000bulbs/elasticsearch:2.3.5-alpine
        ports:
          - 9200:9200
          - 9300:9300

      elasticsearch_updated:
        image: docker.elastic.co/elasticsearch/elasticsearch:7.11.1
        ports:
          - 9201:9200
          - 9301:9300
        env:
          discovery.type: single-node

    steps:
      - name: Install dependencies
        run: |
          sudo apt update -y &&
          sudo apt install -y \
            build-essential curl libcurl4-openssl-dev libfontconfig libfreetype6 \
            libx11-6 libxext6 libxml2-utils libxrender1 xz-utils zlib1g &&
          curl -k -L -o wkhtmltopdf.tar.xz https://github.com/wkhtmltopdf/wkhtmltopdf/releases/download/0.12.4/wkhtmltox-0.12.4_linux-generic-amd64.tar.xz &&
          tar -xf wkhtmltopdf.tar.xz &&
          sudo mv wkhtmltox/bin/wkhtmltopdf /usr/local/bin/wkhtmltopdf &&
          sudo chmod +x /usr/local/bin/wkhtmltopdf

      - name: Checkout code
        uses: actions/checkout@v3

      - name: Setup Ruby
        uses: ruby/setup-ruby@v1.144.2
        with:
          bundler-cache: true

      - name: Setup test database
        env:
          RAILS_ENV: test
          RAILS_MASTER_KEY: ${{ secrets.RAILS_MASTER_KEY }}
        run: bin/rails db:reset db:migrate

      - name: Setup test legacy database
        env:
          RAILS_ENV: test
          RAILS_MASTER_KEY: ${{ secrets.RAILS_MASTER_KEY }}
        run: bin/rails db:legacy:rebuild

      - name: Run tests
        env:
          RAILS_ENV: test
          RAILS_MASTER_KEY: ${{ secrets.RAILS_MASTER_KEY }}
        run: bundle exec rspec -f j -o tmp/rspec_results.json -f p

      - name: RSpec Report
        uses: SonicGarden/rspec-report-action@v2.1.1
        with:
          token: ${{ secrets.GITHUB_TOKEN }}
          json-path: tmp/rspec_results.json
        if: always()

  deploy:
    needs: test
    runs-on: ubuntu-latest
    if: ${{ github.repository_owner == '1000Bulbs' && (
      github.ref == 'refs/heads/staging' ||
      github.ref == 'refs/heads/master') }}

    steps:
      - name: Install dependencies
        run: |
          sudo apt update -y &&
          sudo apt install -y \
            build-essential curl libcurl4-openssl-dev libfontconfig libfreetype6 \
            libx11-6 libxext6 libxml2-utils libxrender1 xz-utils zlib1g &&
          curl -k -L -o wkhtmltopdf.tar.xz https://github.com/wkhtmltopdf/wkhtmltopdf/releases/download/0.12.4/wkhtmltox-0.12.4_linux-generic-amd64.tar.xz &&
          tar -xf wkhtmltopdf.tar.xz &&
          sudo mv wkhtmltox/bin/wkhtmltopdf /usr/local/bin/wkhtmltopdf &&
          sudo chmod +x /usr/local/bin/wkhtmltopdf

      - name: Checkout code
        uses: actions/checkout@v3

      - name: Setup Ruby
        uses: ruby/setup-ruby@v1.144.2
        with:
          bundler-cache: true

      - name: Deploy to staging
        if: ${{ github.ref == 'refs/heads/staging' }}
        uses: miloserdow/capistrano-deploy@master
        with:
          target: staging
          deploy_key: ${{ secrets.DEPLOY_ENC_KEY }}
          enc_rsa_key_val: ${{ secrets.RSA_ENC_KEY }}

      - name: Deploy to production
        if: ${{ github.ref == 'refs/heads/master' }}
        uses: miloserdow/capistrano-deploy@master
        with:
          target: production
          deploy_key: ${{ secrets.DEPLOY_ENC_KEY }}
          enc_rsa_key_val: ${{ secrets.RSA_ENC_KEY }}
